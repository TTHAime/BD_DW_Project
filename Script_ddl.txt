CREATE TABLE USR_TYPE (
    USR_TYPE_ID NUMBER PRIMARY KEY,
    NAME        VARCHAR2(100) NOT NULL,

    CREATED_AT  TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    UPDATED_AT  TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    CREATED_BY  NUMBER,
    UPDATED_BY  NUMBER
);

CREATE TABLE APP_USER (
    USR_ID      NUMBER PRIMARY KEY,
    USERNAME    VARCHAR2(50)  NOT NULL UNIQUE,
    PASSWORD    VARCHAR2(100) NOT NULL,
    NAME        VARCHAR2(100),
    EMAIL       VARCHAR2(100),
    ADDRESS1    VARCHAR2(200),
    ADDRESS2    VARCHAR2(200),
    TEL1        VARCHAR2(20),
    TEL2        VARCHAR2(20),
    USR_TYPE_ID NUMBER NOT NULL,

    CREATED_AT  TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    UPDATED_AT  TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    CREATED_BY  NUMBER,
    UPDATED_BY  NUMBER,

    CONSTRAINT FK_APP_USER_TYPE
        FOREIGN KEY (USR_TYPE_ID)
        REFERENCES USR_TYPE(USR_TYPE_ID)
);

CREATE TABLE CATEGORY (
    CAT_ID     NUMBER PRIMARY KEY,
    NAME       VARCHAR2(100) NOT NULL,

    CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    CREATED_BY NUMBER,
    UPDATED_BY NUMBER
);

CREATE TABLE PRD_TYPE (
    PRD_TYPE_ID NUMBER PRIMARY KEY,
    NAME        VARCHAR2(100) NOT NULL,

    CREATED_AT  TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    UPDATED_AT  TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    CREATED_BY  NUMBER,
    UPDATED_BY  NUMBER

    CONSTRAINT FK_PRD_TYPE_CAT
        FOREIGN KEY (CAT_ID)
        REFERENCES CATEGORY(CAT_ID),

    -- กันชื่อ type ซ้ำในหมวดเดียวกัน 
    CONSTRAINT UQ_PRD_TYPE_CAT_NAME
        UNIQUE (CAT_ID, NAME)
);

CREATE TABLE PAY_STAT (
    PAY_STAT_ID NUMBER PRIMARY KEY,
    NAME        VARCHAR2(50) NOT NULL,

    CREATED_AT  TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    UPDATED_AT  TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    CREATED_BY  NUMBER,
    UPDATED_BY  NUMBER
);

CREATE TABLE SHP_STAT (
    SHP_STAT_ID NUMBER PRIMARY KEY,
    NAME        VARCHAR2(50) NOT NULL,

    CREATED_AT  TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    UPDATED_AT  TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    CREATED_BY  NUMBER,
    UPDATED_BY  NUMBER
);

CREATE TABLE PERIOD (
    PERIOD_ID  NUMBER PRIMARY KEY,
    NAME       VARCHAR2(100),
    START_DATE DATE,
    END_DATE   DATE,

    CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    CREATED_BY NUMBER,
    UPDATED_BY NUMBER
);



CREATE TABLE SHOP (
    SHOP_ID    NUMBER PRIMARY KEY,
    SHOP_NAME  VARCHAR2(100) NOT NULL,
    RATING_AVG NUMBER(3,2),
    USR_ID     NUMBER NOT NULL,

    CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    CREATED_BY NUMBER,
    UPDATED_BY NUMBER,

    CONSTRAINT FK_SHOP_USR
        FOREIGN KEY (USR_ID)
        REFERENCES APP_USER(USR_ID),

    CONSTRAINT UQ_SHOP_USR UNIQUE (USR_ID)
);

CREATE TABLE PRODUCT (
    PRD_ID      NUMBER PRIMARY KEY,
    NAME        VARCHAR2(100) NOT NULL,
    DESCRIPTION VARCHAR2(255),
    PRICE       NUMBER(10,2),
    STOCK       NUMBER,
    DISCOUNT    NUMBER(5,2),
    CAT_ID      NUMBER NOT NULL,
    PRD_TYPE_ID NUMBER NOT NULL,
    SHOP_ID     NUMBER NOT NULL,

    CREATED_AT  TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    UPDATED_AT  TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    CREATED_BY  NUMBER,
    UPDATED_BY  NUMBER,

    CONSTRAINT FK_PRODUCT_CAT
        FOREIGN KEY (CAT_ID)
        REFERENCES CATEGORY(CAT_ID),

    CONSTRAINT FK_PRODUCT_TYPE
        FOREIGN KEY (PRD_TYPE_ID)
        REFERENCES PRD_TYPE(PRD_TYPE_ID),

    CONSTRAINT FK_PRODUCT_SHOP
        FOREIGN KEY (SHOP_ID)
        REFERENCES SHOP(SHOP_ID)
);

CREATE TABLE ORDERS (
    ORD_ID      NUMBER PRIMARY KEY,
    ORDER_DATE  DATE,
    TOTAL_AMOUNT   NUMBER(10,2),
    TOTAL_DISCOUNT NUMBER(10,2),
    USR_ID      NUMBER NOT NULL,
    PAY_STAT_ID NUMBER NOT NULL,

    CREATED_AT  TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    UPDATED_AT  TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    CREATED_BY  NUMBER,
    UPDATED_BY  NUMBER,

    CONSTRAINT FK_ORDER_USR
        FOREIGN KEY (USR_ID)
        REFERENCES APP_USER(USR_ID),

    CONSTRAINT FK_ORDER_PAYSTAT
        FOREIGN KEY (PAY_STAT_ID)
        REFERENCES PAY_STAT(PAY_STAT_ID)
);



CREATE TABLE ORD_DTL (
    ORD_ID      NUMBER NOT NULL,
    SEQ         NUMBER NOT NULL,
    QTY         NUMBER,
    UNIT_PRICE  NUMBER(10,2),
    DISCOUNT    NUMBER(5,2),
    COMMENT_TEXT VARCHAR2(255),
    RATING      NUMBER(2,1),
    PRD_ID      NUMBER NOT NULL,
    SHP_STAT_ID NUMBER NOT NULL,

    CREATED_AT  TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    UPDATED_AT  TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    CREATED_BY  NUMBER,
    UPDATED_BY  NUMBER,

    CONSTRAINT PK_ORD_DTL
        PRIMARY KEY (ORD_ID, SEQ),

    CONSTRAINT FK_OD_ORD
        FOREIGN KEY (ORD_ID)
        REFERENCES ORDERS(ORD_ID),

    CONSTRAINT FK_OD_PRD
        FOREIGN KEY (PRD_ID)
        REFERENCES PRODUCT(PRD_ID),

    CONSTRAINT FK_OD_SHPSTAT
        FOREIGN KEY (SHP_STAT_ID)
        REFERENCES SHP_STAT(SHP_STAT_ID)
);

CREATE OR REPLACE TRIGGER TRG_ORD_DTL_SEQ
BEFORE INSERT ON ORD_DTL
FOR EACH ROW
BEGIN
  IF :NEW.SEQ IS NULL THEN
    SELECT NVL(MAX(SEQ), 0) + 1
      INTO :NEW.SEQ
      FROM ORD_DTL
     WHERE ORD_ID = :NEW.ORD_ID;
  END IF;
END;
/
SHOW ERRORS;



CREATE TABLE CAMPAIGN (
    CMP_ID     NUMBER PRIMARY KEY,
    NAME       VARCHAR2(100),
    DISCOUNT   NUMBER(5,2),
    START_DATE DATE,
    END_DATE   DATE,
    PERIOD_ID  NUMBER NOT NULL,

    CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    CREATED_BY NUMBER,
    UPDATED_BY NUMBER,

    CONSTRAINT FK_CAMPAIGN_PERIOD
        FOREIGN KEY (PERIOD_ID)
        REFERENCES PERIOD(PERIOD_ID)
);

CREATE TABLE CMP_PRD (
    CMP_ID    NUMBER NOT NULL,
    SEQ       NUMBER NOT NULL,
    PRD_ID    NUMBER NOT NULL,

    CREATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    CREATED_BY NUMBER,
    UPDATED_BY NUMBER,

    CONSTRAINT PK_CMP_PRD
        PRIMARY KEY (CMP_ID, SEQ),

    CONSTRAINT UQ_CMP_PRD_CMP_PRD
        UNIQUE (CMP_ID, PRD_ID),

    CONSTRAINT FK_CP_CMP
        FOREIGN KEY (CMP_ID)
        REFERENCES CAMPAIGN(CMP_ID),

    CONSTRAINT FK_CP_PRD
        FOREIGN KEY (PRD_ID)
        REFERENCES PRODUCT(PRD_ID)
);

CREATE OR REPLACE TRIGGER TRG_CMP_PRD_SEQ
BEFORE INSERT ON CMP_PRD
FOR EACH ROW
BEGIN
  IF :NEW.SEQ IS NULL THEN
    SELECT NVL(MAX(SEQ), 0) + 1
      INTO :NEW.SEQ
      FROM CMP_PRD
     WHERE CMP_ID = :NEW.CMP_ID;
  END IF;
END;
/
SHOW ERRORS;



